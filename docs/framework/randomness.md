# 随机系统框架设计

> 本文档记录游戏的随机性机制设计和演变过程
> 创建时间：2025-11-13
> 最后更新：2025-11-14

---

## ⚠️ 当前状态（2025-11-14）

**重大变更**：代码已完全重构，原六层随机系统已废弃

- **旧代码状态**：备份在 `src/game.js.backup`（5600+ 行）
- **新代码状态**：`src/game.js`（302 行）- 最简化版本
- **保留内容**：
  - 基础游戏流程（开始/结束）
  - 角色生成（使用 config.js）
  - 年龄跳跃（使用 `GameConfig.getAgeJump()`）
  - 排行榜系统
- **删除内容**：
  - ❌ 六层动态随机系统
  - ❌ 属性反转机制
  - ❌ 世界混乱度
  - ❌ 连胜/连败系统
  - ❌ 所有事件数据（141个事件）
  - ❌ 所有复杂的概率计算

**下一步**：重新设计随机系统，本文档将记录新的设计思路

---

## 📜 历史记录：六层随机性框架（已废弃）

> 以下内容仅作历史记录，当前代码中不存在

### 当前实现（game.js triggerRandomEvent()）

```
执行顺序（每次调用 triggerRandomEvent() 时）：

第1层：游戏自我关闭彩蛋
  - 位置：game.js:479-483
  - 概率：0.5%（固定）
  - 触发 → 游戏强制结束

第2层：旁白事件（自动跳跃年龄）
  - 位置：game.js:485-490
  - 概率：calculateNarrativeChance() 计算（2%-25%）
  - 受年龄段影响：
    * baby: 15%
    * teen: 5%
    * young: 3%
    * middle: 8%
    * elder: 12%
  - 触发 → triggerNarrativeEvent()

第3层：突发死亡事件 ⚠️
  - 位置：game.js:492-498
  - 概率：(100 - luck) / 200 = 0-50%基础
  - 再乘以：(1 + worldChaos * 0.5)
  - 条件：age > 5
  - 触发 → triggerSuddenDeath() → 直接死亡
  - **问题**：概率过高，导致0岁直接死亡

第4层：正常选择事件
  - 位置：game.js:500-559
  - 概率：如果前3层都没触发，100%进入
  - 从 gameEvents 数组筛选符合年龄的事件
  - 通过加权随机选择事件
  - 显示选项让玩家选择
```

---

## 🔧 优化记录

### 2025-11-13 会话3 - 修复第3层突发死亡概率

**问题诊断**：

用户测试结果：
```
第1次游戏：只有1个选择，大量旁白，15岁死亡
第2次游戏：运气22，0岁直接死亡（打疫苗过敏）
第3次游戏：运气50，0岁直接死亡（呛奶窒息）
```

**根本原因**：

第3层突发死亡概率计算错误：
```javascript
// 旧代码（错误）
let suddenDeathChance = (100 - luck) / 200;  // 运气22 → 39%概率
suddenDeathChance *= (1 + worldChaos * 0.5); // 再乘1.25倍 → 48.75%
```

**用户分析**：

1. **设计初衷被误解**：
   - 用户原本想要：六层独立的小概率随机判定
   - 实际实现：第3层绑定运气值计算，变成高概率死亡

2. **突发死亡的本质**：
   - 目的：增加"同一选择，不同结果"的不确定性
   - 目的：让玩家无法分辨"正确选项"，模拟人生随机性
   - 不应该：成为主要死亡方式，影响游戏流畅度

3. **合理概率**：
   - 目标游戏：16-22个选择
   - 建议概率：2-5%
   - 计算：16 × 3% = 0.48次，即平均一局可能遇到0-1次突发死亡

**修复方案**：

```javascript
// 新代码（已修复）
const suddenDeathChance = 0.03;  // 固定3%概率
if (Math.random() < suddenDeathChance) {
    this.triggerSuddenDeath();
    return;
}
```

**修改位置**：
- 文件：src/game.js
- 行号：492-497
- 提交时间：2025-11-13

**待测试**：
- [ ] 用户体验修复后的游戏
- [ ] 根据反馈调整3%概率（可能需要1%-5%之间调整）

---

## 🎯 下一步优化计划

### 待讨论的层级

- [ ] **第2层：旁白事件概率** - 第1次测试只有1个选择，大量旁白
- [ ] **第1层：游戏关闭彩蛋** - 0.5%是否合适
- [ ] **第4层：选择事件权重** - 如何确保年龄段均匀分布

### 设计原则（确认）

1. **完全随机 vs 计算随机**：
   - ✅ 用户期望：固定小概率，不受属性影响（或影响很小）
   - ❌ 避免：用属性值计算大概率（如 (100-luck)/200）

2. **每层独立**：
   - 每层都是独立的小概率判定
   - 随机性体现在"触发了哪一层"，而不是"某层概率特别高"

3. **用户体验优先**：
   - 在满足体验的前提下适当添加不确定性
   - 不能让用户"根本玩不下去"

---

## 📝 设计问题记录

### Q1: 六层随机的初衷是什么？
- **用户答案**：想要实现"完全随机"的概率分布
- **问题**：当前实现绑定运气值，导致适得其反

### Q2: 年龄是否应该影响突发死亡？
- **用户答案**：年龄和突发死亡毫无关系
- **结论**：移除年龄判定（age > 5），只保留固定概率

### Q3: 运气值应该如何影响？
- **待讨论**：属性系统需要整体重构，暂不在此层讨论

---

## 🔄 版本历史

- **v0.1** (初始设计) - 六层随机框架，突发死亡绑定运气值
- **v0.2** (2025-11-13) - 修复第3层，改为固定3%概率
- **v0.3** (2025-11-14) - 完全重构，删除六层系统，回到最简框架

---

## 🎯 新设计方向（待讨论）

**当前待完成**：

1. **事件系统设计** - 如何组织和触发事件
2. **随机机制设计** - 如何实现合理的随机性
3. **死亡机制设计** - 如何平衡游戏难度

**设计原则**（基于之前的经验教训）：

- ✅ 简单清晰，易于理解和维护
- ✅ 固定小概率，避免复杂计算
- ✅ 用户体验优先，不能让玩家"根本玩不下去"
- ✅ 框架先行，先讨论设计再写代码

---

## 📌 快速参考

### 当前代码状态（2025-11-14）

| 功能 | 位置 | 状态 |
|------|------|------|
| 角色生成 | `game.js` generateCharacter() | ✅ 已实现 |
| 年龄跳跃 | `config.js` getAgeJump() | ✅ 已实现 |
| 事件系统 | - | ⚠️ 待实现 |
| 随机机制 | - | ⚠️ 待重新设计 |

### 历史代码位置（game.js.backup）

| 层级 | 位置 | 概率 | 状态 |
|------|------|------|------|
| 第1层 | 479-483 | 0.5% | 已删除 |
| 第2层 | 485-490 | 2%-25% | 已删除 |
| 第3层 | 492-497 | 3% | 已删除 |
| 第4层 | 500-559 | 剩余100% | 已删除 |
